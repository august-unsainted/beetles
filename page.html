<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- Установка кодировки и адаптивности страницы -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Интерактивная таблица жужелиц</title>
    <!-- Подключение стилей Bootstrap и Grid.js для оформления таблицы -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
</head>
<body>
    <!-- Основной контейнер страницы с отступами -->
    <div class="container py-4">
        <!-- Заголовок страницы -->
        <h1 class="mb-4 text-center fw-bold">Интерактивная таблица по видам жужелиц</h1>
        
        <!-- Кнопка для открытия модального окна создания новой записи -->
        <div class="d-flex justify-content-center mb-3">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createBeetleModal">
                Создать новую жужелицу
            </button>
        </div>

        <!-- Контейнер для отображения таблицы с данными -->
        <div id="table-wrapper" class="shadow-sm rounded"></div>
    </div>

    <!-- Контейнер для уведомлений (тостов) -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="notification-container"></div>
    </div>

    <!-- Модальное окно для просмотра и редактирования деталей жужелицы -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-semibold" id="detailsModalLabel">Детали жужелицы</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Форма для редактирования данных жужелицы -->
                    <form id="beetleDetailsForm">
                        <input type="hidden" id="modalBeetleIndex">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="modalFamily" class="form-label fw-medium">Семейство</label>
                                <select class="form-select form-select-sm" id="modalFamily"></select>
                            </div>
                            <div class="col-md-6">
                                <label for="modalTribe" class="form-label fw-medium">Триба</label>
                                <select class="form-select form-select-sm" id="modalTribe"></select>
                            </div>
                            <div class="col-md-6">
                                <label for="modalGenus" class="form-label fw-medium">Род</label>
                                <select class="form-select form-select-sm" id="modalGenus"></select>
                            </div>
                            <div class="col-md-6">
                                <label for="modalSpecies" class="form-label fw-medium">Вид</label>
                                <input type="text" class="form-control form-control-sm" id="modalSpecies">
                            </div>
                            <div class="col-md-6">
                                <label for="modalDistrict" class="form-label fw-medium">Район сбора</label>
                                <select class="form-select form-select-sm" id="modalDistrict"></select>
                            </div>
                            <div class="col-md-6">
                                <label for="modalLocation" class="form-label fw-medium">Точка сбора</label>
                                <select class="form-select form-select-sm" id="modalLocation"></select>
                            </div>
                            <div class="col-12">
                                <label for="modalNotes" class="form-label fw-medium">Примечание</label>
                                <textarea class="form-control form-control-sm" id="modalNotes" rows="3"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger btn-sm" id="deleteBeetleBtn">Удалить</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Закрыть</button>
                    <button type="button" class="btn btn-primary btn-sm" id="saveDetailsBtn">Сохранить изменения</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для создания новой жужелицы -->
    <div class="modal fade" id="createBeetleModal" tabindex="-1" aria-labelledby="createBeetleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-semibold" id="createBeetleModalLabel">Создать новую жужелицу</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Форма для ввода данных новой жужелицы -->
                    <form id="createBeetleForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="newFamily" class="form-label fw-medium">Семейство</label>
                                <select class="form-select form-select-sm" id="newFamily" required></select>
                            </div>
                            <div class="col-md-6">
                                <label for="newTribe" class="form-label fw-medium">Триба</label>
                                <select class="form-select form-select-sm" id="newTribe" required></select>
                            </div>
                            <div class="col-md-6">
                                <label for="newGenus" class="form-label fw-medium">Род</label>
                                <select class="form-select form-select-sm" id="newGenus" required></select>
                            </div>
                            <div class="col-md-6">
                                <label for="newSpecies" class="form-label fw-medium">Вид</label>
                                <input type="text" class="form-control form-control-sm" id="newSpecies" required>
                            </div>
                            <div class="col-md-6">
                                <label for="newDistrict" class="form-label fw-medium">Район сбора</label>
                                <select class="form-select form-select-sm" id="newDistrict" required></select>
                            </div>
                            <div class="col-md-6">
                                <label for="newLocation" class="form-label fw-medium">Точка сбора</label>
                                <select class="form-select form-select-sm" id="newLocation" required></select>
                            </div>
                            <div class="col-12">
                                <label for="newNotes" class="form-label fw-medium">Примечание</label>
                                <textarea class="form-control form-select-sm" id="newNotes" rows="3"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-success btn-sm" id="createBeetleBtn">Создать</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для подтверждения сохранения изменений -->
    <div class="modal fade" id="confirmSaveModal" tabindex="-1" aria-labelledby="confirmSaveModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-semibold" id="confirmSaveModalLabel">Несохранённые изменения</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">Данные не сохранены. Сохранить изменения?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal" id="cancelSaveBtn">Отмена</button>
                    <button type="button" class="btn btn-primary btn-sm" id="confirmSaveBtn">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Подключение библиотек Grid.js и Bootstrap для функциональности таблицы и модальных окон -->
    <script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Исходные данные жужелиц в виде массива
        const beetles = [
            ['CICINDELINAE', 'CICINDELINI', 'Cylindera', 'Cylindera (Eugrapha) mongolica', 'УЛАН-УДЭ', 'Верхняя Березовка', ''],
            ['CARABINAE', 'PELOPHILINI', 'Pelophila', 'Pelophila (s. str.) borealis', 'СЕВЕРО–БАЙКАЛЬСКИЙ РАЙОН', 'Аяя', 'Найден у водоема'],
            ['CARABINAE', 'NEBRIINI', 'Nebria', 'Nebria (Boreonebria) sajanica', 'ОКИНСКИЙ РАЙОН', 'Долина вулканов', 'Высокогорный вид'],
            ['CARABINAE', 'NOTIOPHILINI', 'Notiophilus', 'Notiophilus (s. str.) sibiricus', 'ПРИБАЙКАЛЬСКИЙ РАЙОН', 'Горячинск', ''],
            ['CARABINAE', 'CARABINI', 'Carabus', 'Carabus (Morphocarabus) hummeli', 'ТУНКИНСКИЙ РАЙОН', 'Аршан', 'Встречается в лесах'],
            ['CARABINAE', 'ELAPHRINI', 'Elaphrus', 'Elaphrus (Neoelaphrus) sibiricus', 'ЕРАВНИНСКИЙ РАЙОН', 'Большое Еравное', 'Обитает на болотах'],
            ['CARABINAE', 'LORICERINI', 'Loricera', 'Loricera (s. str.) pilicornis', 'КАБАНСКИЙ РАЙОН', 'Байкальский заповедник', 'Вблизи воды'],
            ['CARABINAE', 'PTEROSTICHINI', 'Pterostichus', 'Pterostichus (Cryobius) tunkinensis', 'ТУНКИНСКИЙ РАЙОН', 'Тункинские гольцы', 'Эндемик'],
            ['CARABINAE', 'ZABRINI', 'Amara', 'Amara (Bradytus) irkutensis', 'ИВОЛГИНСКИЙ РАЙОН', 'Тапхар', 'Часто на полях'],
            ['CARABINAE', 'HARPALINI', 'Harpalus', 'Harpalus (s. str.) zabroides', 'КЯХТИНСКИЙ РАЙОН', 'Кяхта', '']
        ];

        // Переменные для отслеживания изменений в данных
        let hasUnsavedChanges = false;
        let originalBeetleData = [];

        // Функция для получения уникальных значений из столбца данных
        function getUniqueValues(data, columnIndex) {
            const values = data.map(row => row[columnIndex]);
            return [...new Set(values)];
        }

        // Хранение уникальных значений для выпадающих списков
        let uniqueData = {
            'Семейство': getUniqueValues(beetles, 0),
            'Триба': getUniqueValues(beetles, 1),
            'Род': getUniqueValues(beetles, 2),
            'Район сбора': getUniqueValues(beetles, 4),
            'Точка сбора': getUniqueValues(beetles, 5)
        };

        // Функция для создания HTML-кода для выпадающих списков
        function createOptionsHtml(options, currentValue = '') {
            let optionsHtml = '<option value="">Выбрать...</option>';
            options.forEach(option => {
                const selected = option === currentValue ? 'selected' : '';
                optionsHtml += `<option value="${option}" ${selected}>${option}</option>`;
            });
            return optionsHtml;
        }

        // Конфигурация столбцов для таблицы Grid.js
        const columnsConfig = [
            { name: 'Семейство', id: 'family' },
            { name: 'Триба', id: 'tribe' },
            { name: 'Род', id: 'genus' },
            { name: 'Вид', id: 'species' },
            { name: 'Район сбора', id: 'district' },
            { name: 'Точка сбора', id: 'location' },
            { name: 'Действия', 
              sort: false,
              formatter: (cell, row) => {
                const originalRowData = row.cells.map(c => c.data);
                const rowIndex = beetles.findIndex(b => 
                    b[0] === originalRowData[0] && 
                    b[1] === originalRowData[1] && 
                    b[2] === originalRowData[2] && 
                    b[3] === originalRowData[3]
                );
                return gridjs.html(`<button class="btn btn-secondary btn-sm view-details-btn" data-bs-toggle="modal" data-bs-target="#detailsModal" data-row-index="${rowIndex}">Подробнее</button>`);
              }
            }
        ];

        // Инициализация таблицы Grid.js
        const grid = new gridjs.Grid({
            columns: columnsConfig, 
            data: beetles,
            sort: true,
            search: true,
            pagination: {
                enabled: true,
                limit: 10
            },
            className: {
                table: 'table table-bordered table-striped table-hover table-sm',
                thead: 'table-dark'
            },
            language: {
                'search': { 'placeholder': 'Поиск по таблице...' },
                'pagination': {
                    'previous': 'Назад', 'next': 'Вперед', 'showing': 'Показано с',
                    'to': 'по', 'of': 'из', 'results': 'результатов'
                },
                'loading': 'Загрузка...',
                'noRecordsFound': 'Записей не найдено',
                'error': 'Произошла ошибка при загрузке данных'
            }
        }).render(document.getElementById("table-wrapper"));

        // Функция для отображения уведомлений (тостов)
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('notification-container');
            const toastId = `toast-${Date.now()}`;
            const toastHtml = `
                <div class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true" id="${toastId}">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();
            toastElement.addEventListener('hidden.bs.toast', function () {
                toastElement.remove();
            });
        }

        // Функция для заполнения выпадающих списков в модальных окнах
        function populateModalSelects(modalId, currentBeetleData = []) {
            const familySelect = document.getElementById(`${modalId}Family`);
            const tribeSelect = document.getElementById(`${modalId}Tribe`);
            const genusSelect = document.getElementById(`${modalId}Genus`);
            const districtSelect = document.getElementById(`${modalId}District`);
            const locationSelect = document.getElementById(`${modalId}Location`);

            familySelect.innerHTML = createOptionsHtml(uniqueData['Семейство'], currentBeetleData[0]);
            tribeSelect.innerHTML = createOptionsHtml(uniqueData['Триба'], currentBeetleData[1]);
            genusSelect.innerHTML = createOptionsHtml(uniqueData['Род'], currentBeetleData[2]);
            districtSelect.innerHTML = createOptionsHtml(uniqueData['Район сбора'], currentBeetleData[4]);
            locationSelect.innerHTML = createOptionsHtml(uniqueData['Точка сбора'], currentBeetleData[5]);
        }

        // Обработчик открытия модального окна редактирования
        const detailsModal = document.getElementById('detailsModal');
        detailsModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const rowIndex = button.getAttribute('data-row-index');
            const beetle = beetles[rowIndex];

            document.getElementById('modalBeetleIndex').value = rowIndex;
            populateModalSelects('modal', beetle);
            document.getElementById('modalSpecies').value = beetle[3];
            document.getElementById('modalNotes').value = beetle[6] || '';
            originalBeetleData = [...beetle];
            hasUnsavedChanges = false;
        });

        // Отслеживание изменений в форме редактирования
        const beetleDetailsForm = document.getElementById('beetleDetailsForm');
        beetleDetailsForm.addEventListener('input', function() {
            hasUnsavedChanges = true;
        });

        // Проверка несохранённых изменений при закрытии модального окна
        detailsModal.addEventListener('hide.bs.modal', function (event) {
            const rowIndex = document.getElementById('modalBeetleIndex').value;
            const currentBeetleData = [
                document.getElementById('modalFamily').value,
                document.getElementById('modalTribe').value,
                document.getElementById('modalGenus').value,
                document.getElementById('modalSpecies').value,
                document.getElementById('modalDistrict').value,
                document.getElementById('modalLocation').value,
                document.getElementById('modalNotes').value
            ];
            const isDataChanged = JSON.stringify(currentBeetleData) !== JSON.stringify(originalBeetleData);

            if (isDataChanged && hasUnsavedChanges) {
                event.preventDefault();
                const confirmSaveModal = new bootstrap.Modal(document.getElementById('confirmSaveModal'), {
                    backdrop: 'static'
                });
                confirmSaveModal.show();

                const confirmSaveBtn = document.getElementById('confirmSaveBtn');
                const saveHandler = function() {
                    document.getElementById('saveDetailsBtn').click();
                    confirmSaveModal.hide();
                    confirmSaveBtn.removeEventListener('click', saveHandler);
                };
                confirmSaveBtn.addEventListener('click', saveHandler);

                const cancelSaveBtn = document.getElementById('cancelSaveBtn');
                const cancelHandler = function() {
                    hasUnsavedChanges = false;
                    confirmSaveModal.hide();
                    const modalInstance = bootstrap.Modal.getInstance(detailsModal);
                    modalInstance.hide();
                    showToast('Изменения отменены.', 'info');
                    cancelSaveBtn.removeEventListener('click', cancelHandler);
                };
                cancelSaveBtn.addEventListener('click', cancelHandler);
            }
        });

        // Обработчик сохранения изменений в записи
        document.getElementById('saveDetailsBtn').addEventListener('click', function() {
            const rowIndex = document.getElementById('modalBeetleIndex').value;
            if (rowIndex !== "") {
                const newFamily = document.getElementById('modalFamily').value;
                const newTribe = document.getElementById('modalTribe').value;
                const newGenus = document.getElementById('modalGenus').value;
                const newSpecies = document.getElementById('modalSpecies').value;
                const newDistrict = document.getElementById('modalDistrict').value;
                const newLocation = document.getElementById('modalLocation').value;
                const newNotes = document.getElementById('modalNotes').value;

                beetles[rowIndex][0] = newFamily;
                beetles[rowIndex][1] = newTribe;
                beetles[rowIndex][2] = newGenus;
                beetles[rowIndex][3] = newSpecies;
                beetles[rowIndex][4] = newDistrict;
                beetles[rowIndex][5] = newLocation;
                beetles[rowIndex][6] = newNotes;

                updateGridAndUniqueValues();
                hasUnsavedChanges = false;
                const modalInstance = bootstrap.Modal.getInstance(detailsModal);
                modalInstance.hide();
                showToast('Изменения сохранены!', 'success');
            }
        });

        // Модальное окно и форма для создания новой записи
        const createBeetleModal = document.getElementById('createBeetleModal');
        const createBeetleForm = document.getElementById('createBeetleForm');

        // Функция для сохранения данных формы в localStorage
        function saveCreateFormData() {
            const formData = {
                newFamily: document.getElementById('newFamily').value,
                newTribe: document.getElementById('newTribe').value,
                newGenus: document.getElementById('newGenus').value,
                newSpecies: document.getElementById('newSpecies').value,
                newDistrict: document.getElementById('newDistrict').value,
                newLocation: document.getElementById('newLocation').value,
                newNotes: document.getElementById('newNotes').value
            };
            localStorage.setItem('createBeetleFormData', JSON.stringify(formData));
        }

        // Функция для восстановления данных формы из localStorage
        function restoreCreateFormData() {
            const savedData = localStorage.getItem('createBeetleFormData');
            if (savedData) {
                const formData = JSON.parse(savedData);
                document.getElementById('newFamily').value = formData.newFamily || '';
                document.getElementById('newTribe').value = formData.newTribe || '';
                document.getElementById('newGenus').value = formData.newGenus || '';
                document.getElementById('newSpecies').value = formData.newSpecies || '';
                document.getElementById('newDistrict').value = formData.newDistrict || '';
                document.getElementById('newLocation').value = formData.newLocation || '';
                document.getElementById('newNotes').value = formData.newNotes || '';
            }
        }

        // Сохранение данных формы при их изменении
        createBeetleForm.addEventListener('input', saveCreateFormData);

        // Восстановление данных формы при открытии модального окна
        createBeetleModal.addEventListener('show.bs.modal', function () {
            document.getElementById('createBeetleForm').reset();
            populateModalSelects('new');
            restoreCreateFormData();
        });

        // Обработчик создания новой жужелицы
        document.getElementById('createBeetleBtn').addEventListener('click', function() {
            const newFamily = document.getElementById('newFamily').value;
            const newTribe = document.getElementById('newTribe').value;
            const newGenus = document.getElementById('newGenus').value;
            const newSpecies = document.getElementById('newSpecies').value;
            const newDistrict = document.getElementById('newDistrict').value;
            const newLocation = document.getElementById('newLocation').value;
            const newNotes = document.getElementById('newNotes').value;

            if (!newFamily || !newTribe || !newGenus || !newSpecies || !newDistrict || !newLocation) {
                showToast('Пожалуйста, заполните все обязательные поля.', 'danger');
                return;
            }

            const newBeetle = [newFamily, newTribe, newGenus, newSpecies, newDistrict, newLocation, newNotes];
            beetles.push(newBeetle);
            updateGridAndUniqueValues();
            localStorage.removeItem('createBeetleFormData');
            document.getElementById('createBeetleForm').reset();
            const modalInstance = bootstrap.Modal.getInstance(createBeetleModal);
            modalInstance.hide();
            showToast('Новая жужелица успешно добавлена!', 'success');
        });

        // Обработчик удаления записи
        document.getElementById('deleteBeetleBtn').addEventListener('click', function() {
            const rowIndex = document.getElementById('modalBeetleIndex').value;
            if (rowIndex !== "" && confirm('Вы уверены, что хотите удалить эту запись?')) {
                beetles.splice(rowIndex, 1);
                updateGridAndUniqueValues();
                const modalInstance = bootstrap.Modal.getInstance(detailsModal);
                modalInstance.hide();
                showToast('Запись успешно удалена!', 'success');
            }
        });

        // Обновление таблицы и уникальных значений после изменений
        function updateGridAndUniqueValues() {
            uniqueData = {
                'Семейство': getUniqueValues(beetles, 0),
                'Триба': getUniqueValues(beetles, 1),
                'Род': getUniqueValues(beetles, 2),
                'Район сбора': getUniqueValues(beetles, 4),
                'Точка сбора': getUniqueValues(beetles, 5)
            };
            grid.updateConfig({ data: beetles.slice() }).forceRender();
        }
    </script>
</body>
</html>