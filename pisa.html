<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Интерактивная таблица жужелиц</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
  <script src="/js/jquery-3.7.1.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <style>
    .select2-container--default .select2-selection--multiple {
      border: 1px solid #ced4da;
      border-radius: 0.375rem;
      background-color: #fff;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .select2-container {
      width: 100% !important;
    }

    .select2-container--default.select2-container--focus .select2-selection--multiple {
      border-color: #86b7fe;
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    .select2-container--default .select2-selection--multiple .select2-selection__choice {
      background-color: #e9ecef;
      border: 1px solid #adb5bd;
      border-radius: 0.25rem;
      color: #495057;
      transition: background-color 0.15s ease-in-out;
    }

    .select2-container--default .select2-selection--multiple .select2-selection__choice:hover {
      background-color: #dee2e6;
    }

    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
      color: #6c757d;
      transition: color 0.15s ease-in-out;
    }

    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
      color: #dc3545;
    }

    .select2-dropdown {
      border: 1px solid #ced4da;
      border-radius: 0.375rem;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      z-index: 15000;
    }

    .select2-results__option--highlighted {
      background-color: #0d6efd !important;
      color: #fff;
    }

    .select2-selection__choice__remove>span {
      padding-bottom: 6px;
    }

    .select2-container--default .select2-selection--multiple .select2-selection__choice__display {
      padding-left: 6px;
      padding-right: 10px;
    }

    .gridjs-th {
      padding: 6px !important;
    }

    .highlight-column {
      background-color: rgba(255, 235, 59, 0.3) !important;
      transition: background-color 0.2s;
    }

    .modal-body {
      padding: 0.75rem 1rem;
    }

    .modal-body .row {
      margin-bottom: 0.5rem;
    }

    .modal-body .form-label {
      margin-bottom: 0.15rem;
      font-size: 0.8rem;
      font-weight: 500;
      color: #212529;
    }

    .modal-body .form-control,
    .modal-body .form-select {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      height: auto;
    }

    .modal-body h6 {
      font-size: 0.875rem;
      margin-bottom: 0.375rem;
      margin-top: 0.75rem;
    }

    .modal-body h6:first-child {
      margin-top: 0;
    }

    .toggle-geography,
    .toggle-images {
      cursor: pointer;
      color: #0d6efd;
      text-decoration: underline;
      font-size: 0.8rem;
    }

    .modal-section {
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 0.375rem;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .modal-section h6 {
      color: #495057;
      font-weight: 600;
      margin-bottom: 0.5rem;
      margin-top: 0;
      font-size: 0.9rem;
    }

    #chooseColumns {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      padding: 0.75rem;
      min-height: 120px;
    }

    .nav-tabs .nav-link {
      font-size: 0.85rem;
      padding: 0.375rem 0.75rem;
    }

    .nav-tabs .nav-link.active {
      background-color: #0d6efd;
      color: #ffffff;
    }

    .tab-content {
      padding: 0.75rem 0 0 0;
    }

    .tab-pane-content {
      display: flex;
      flex-flow: row wrap;
      gap: 0.5rem;
      align-content: flex-start;
      min-height: 40px;
      align-items: center;
    }

    .form-switch {
      margin-bottom: 0;
      white-space: nowrap;
      min-width: fit-content;
    }

    .form-check-label {
      font-size: 0.85rem;
    }

    legend {
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 0.5rem !important;
    }

    #extra hr {
      margin: 0.5rem 0;
      opacity: 0.5;
    }

    .btn-create-geo {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      flex-shrink: 0;
    }
  </style>
</head>

<body>
  <div class="container-fluid py-4 px-3">
    <div class="card border-0">
      <div class="card-body">
        <section class="mb-4">
          <div class="d-flex flex-column flex-md-row px-0 justify-content-between align-items-start gap-3 w-100">
            <div class="w-100 w-md-50">
              <h1 class="fw-bold text-primary mb-3">Интерактивная таблица жужелиц</h1>
              <button type="button" class="btn btn-primary w-100 w-md-auto" style="min-width: 180px;"
                data-bs-toggle="modal" data-bs-target="#createBeetleModal">+ Создать жужелицу</button>
            </div>
            <fieldset class="w-100 w-md-50" id="chooseColumns">
              <legend class="fs-6 text-muted mb-2">Признаки</legend>
              <ul class="nav nav-tabs" id="columnTabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="main-tab" data-bs-toggle="tab" data-bs-target="#main"
                    type="button" role="tab" aria-controls="main" aria-selected="true">Основные</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="eco-tab" data-bs-toggle="tab" data-bs-target="#eco" type="button"
                    role="tab" aria-controls="eco" aria-selected="false">Экологические</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="geo-tab" data-bs-toggle="tab" data-bs-target="#geo" type="button"
                    role="tab" aria-controls="geo" aria-selected="false">Географические</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="extra-tab" data-bs-toggle="tab" data-bs-target="#extra" type="button"
                    role="tab" aria-controls="extra" aria-selected="false">Дополнительное</button>
                </li>
              </ul>
              <div class="tab-content mt-2" id="columnTabsContent">
                <div class="tab-pane fade show active" id="main" role="tabpanel" aria-labelledby="main-tab">
                  <div class="tab-pane-content">
                    <div class="form-check form-switch">
                      <input class="form-check-input toggle-all-local" type="checkbox" id="toggleAllMain" checked>
                      <label class="form-check-label" for="toggleAllMain"><strong>Все основные признаки</strong></label>
                    </div>
                  </div>
                </div>
                <div class="tab-pane fade" id="eco" role="tabpanel" aria-labelledby="eco-tab">
                  <div class="tab-pane-content">
                    <div class="form-check form-switch">
                      <input class="form-check-input toggle-all-local" type="checkbox" id="toggleAllEco" checked>
                      <label class="form-check-label" for="toggleAllEco"><strong>Все экологические
                          признаки</strong></label>
                    </div>
                  </div>
                </div>
                <div class="tab-pane fade" id="geo" role="tabpanel" aria-labelledby="geo-tab">
                  <div class="tab-pane-content">

                    <div class="form-check form-switch">
                      <input class="form-check-input toggle-all-local" type="checkbox" id="toggleAllGeo" checked>
                      <label class="form-check-label" for="toggleAllGeo"><strong>Все географические
                          признаки</strong></label>
                    </div>

                  </div>
                  <button type="button" class="btn btn-outline-primary btn-sm btn-create-geo" data-bs-toggle="modal"
                    data-bs-target="#createGeoModal">+ Создать район/пункт</button>
                </div>
                <div class="tab-pane fade" id="extra" role="tabpanel" aria-labelledby="extra-tab">
                  <div class="tab-pane-content">
                    <div class="form-check form-switch">
                      <input class="form-check-input toggle-all-global" type="checkbox" id="toggleAllGlobal" checked>
                      <label class="form-check-label" for="toggleAllGlobal"><strong>Все признаки</strong></label>
                    </div>
                    <hr class="my-1">
                  </div>
                </div>
              </div>
            </fieldset>
          </div>
        </section>
        <div style="display: none;">
          <table id="data_table">
            <tbody>
              <tr>
                <td>Подсемейство 1</td>
                <td>Триба 1</td>
                <td>Род 1</td>
                <td>Подрод 1</td>
                <td>Вид 1</td>
                <td>Район 1</td>
                <td>Пункт 1</td>
                <td>Широтная 1</td>
                <td>Долготная 1</td>
                <td>Эко группа 1</td>
                <td>Трофическая 1</td>
                <td>Ярусная 1</td>
                <td>Описание 1</td>
              </tr>
              <tr>
                <td>Подсемейство 2</td>
                <td>Триба 2</td>
                <td>Род 2</td>
                <td>Подрод 2</td>
                <td>Вид 2</td>
                <td>Район 2</td>
                <td>Пункт 2</td>
                <td>Широтная 2</td>
                <td>Долготная 2</td>
                <td>Эко группа 2</td>
                <td>Трофическая 2</td>
                <td>Ярусная 2</td>
                <td>Описание 2</td>
              </tr>
              <tr>
                <td>Подсемейство 3</td>
                <td>Триба 3</td>
                <td>Род 3</td>
                <td>Подрод 3</td>
                <td>Вид 3</td>
                <td>Район 3</td>
                <td>Пункт 3</td>
                <td>Широтная 3</td>
                <td>Долготная 3</td>
                <td>Эко группа 3</td>
                <td>Трофическая 3</td>
                <td>Ярусная 3</td>
                <td>Описание 3</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div id="table-wrapper" class="rounded"></div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="detailsModalLabel">Детали жужелицы</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <input type="hidden" id="edit_id" name="id">
            <div class="modal-section">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0" style="color: black;">Изображения</h6>
                <span class="toggle-images" title="Показать/скрыть управление изображениями">показать</span>
              </div>
              <div class="row" id="images-section" style="display: none;">
                <div class="col-12">
                  <input type="file" class="form-control" id="edit_image" accept="image/*" style="display: none;">
                  <div class="mb-2" id="image-preview">
                    <img
                      src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmOWZhIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzZjNzU3ZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zNWVtIj7QndC10YIg0LjQt9C+0LHRgNCw0LbQtdC90LjRjzwvdGV4dD4KICA8L3N2Zz4K"
                      class="img-thumbnail" style="max-width: 200px; max-height: 150px;">
                  </div>
                  <div class="d-flex gap-2 flex-wrap">
                    <button type="button" class="btn btn-outline-primary btn-sm"
                      onclick="$('#edit_image').click()">Установить</button>
                    <button type="button" class="btn btn-outline-danger btn-sm" id="delete-image">Удалить</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-section">
              <h6 style="color: black;">Таксономия</h6>
              <div class="row mb-3">
                <div class="col-md-4">
                  <label class="form-label">Род</label>
                  <input type="text" class="form-control" id="edit_genus" list="genus-list" placeholder="Выберите род">
                  <datalist id="genus-list">
                    <option value="Род 1">
                    <option value="Род 2">
                  </datalist>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Подрод</label>
                  <input type="text" class="form-control" id="edit_subgenus" list="subgenus-list"
                    placeholder="Выберите подрод">
                  <datalist id="subgenus-list">
                    <option value="Подрод 1">
                    <option value="Подрод 2">
                  </datalist>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Вид</label>
                  <input type="text" class="form-control" id="edit_species">
                </div>
              </div>
            </div>
            <div class="modal-section">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0" style="color: black;">География</h6>
                <span class="toggle-geography" title="Показать/скрыть поля географии">показать</span>
              </div>
              <div class="row" id="geography-section">
                <div class="col-md-6">
                  <label class="form-label">Регионы</label>
                  <select class="form-control multiple-select" id="edit_regions" multiple>
                    <option value="1">Баргузинский район</option>
                    <option value="2">Бичурский район</option>
                    <option value="3">Джидинский район</option>
                    <option value="4">Заиграевский район</option>
                    <option value="5">Закаменский район</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Точки</label>
                  <select class="form-control multiple-select" id="edit_points" multiple>
                    <option value="1" data-region="1">Усть-Баргузин</option>
                    <option value="2" data-region="1">Баргузин</option>
                    <option value="3" data-region="2">Бичура</option>
                    <option value="4" data-region="2">Новосретенское</option>
                    <option value="5" data-region="3">Петропавловка</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="modal-section">
              <h6 style="color: black;">Экологические группы</h6>
              <div class="row">
                <div class="col-md-3">
                  <label class="form-label">Широтная группа</label>
                  <input type="text" class="form-control" id="edit_width_range" list="width-list"
                    placeholder="Выберите группу">
                  <datalist id="width-list">
                    <option value="Широкая">
                    <option value="Узкая">
                  </datalist>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Долготная группа</label>
                  <input type="text" class="form-control" id="edit_long_range" list="long-list"
                    placeholder="Выберите группу">
                  <datalist id="long-list">
                    <option value="Длинная">
                    <option value="Короткая">
                  </datalist>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Экологическая группа</label>
                  <input type="text" class="form-control" id="edit_ecologic_group" list="ecologic-list"
                    placeholder="Выберите группу">
                  <datalist id="ecologic-list">
                    <option value="Лесная">
                    <option value="Степная">
                  </datalist>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Трофическая группа</label>
                  <input type="text" class="form-control" id="edit_trophic_group" list="trophic-list"
                    placeholder="Выберите группу">
                  <datalist id="trophic-list">
                    <option value="Хищник">
                    <option value="Травоядный">
                  </datalist>
                </div>
              </div>
            </div>
            <div class="modal-section">
              <h6 style="color: black;">Описание</h6>
              <div class="row">
                <div class="col-12">
                  <textarea class="form-control" id="edit_description" rows="2"></textarea>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" name="delete" onclick="submitForm()"
                class="btn btn-danger btn-sm me-auto">Удалить</button>
              <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Закрыть</button>
              <button type="button" name="apply" onclick="submitForm()"
                class="btn btn-primary btn-sm">Сохранить</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="createBeetleModal" tabindex="-1" aria-labelledby="createBeetleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="createBeetleModalLabel">Создать новую жужелицу</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="createForm">
            <div class="modal-section">
              <h6>Таксономия</h6>
              <div class="row mb-3">
                <div class="col-md-4">
                  <label class="form-label">Род</label>
                  <select class="form-control" id="create_genus">
                    <option value="">Выберите род</option>
                    <option value="Род 1">Род 1</option>
                    <option value="Род 2">Род 2</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Подрод</label>
                  <select class="form-control" id="create_subgenus">
                    <option value="">Выберите подрод</option>
                    <option value="Подрод 1">Подрод 1</option>
                    <option value="Подрод 2">Подрод 2</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Вид</label>
                  <input type="text" class="form-control" id="create_species">
                </div>
              </div>
            </div>
            <div class="modal-section-divider">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 text-muted">География</h6>
                <button type="button" class="btn btn-sm btn-outline-secondary toggle-geography"
                  title="Показать/скрыть поля географии">👁️</button>
              </div>
              <div class="row mb-3" id="geography-section-create">
                <div class="col-md-6">
                  <label class="form-label">Регионы</label>
                  <select class="form-control multiple-select" id="create_regions" multiple>
                    <option value="1">Баргузинский район</option>
                    <option value="2">Бичурский район</option>
                    <option value="3">Джидинский район</option>
                    <option value="4">Заиграевский район</option>
                    <option value="5">Закаменский район</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Точки</label>
                  <select class="form-control multiple-select" id="create_points" multiple>
                    <option value="1" data-region="1">Усть-Баргузин</option>
                    <option value="2" data-region="1">Баргузин</option>
                    <option value="3" data-region="2">Бичура</option>
                    <option value="4" data-region="2">Новосретенское</option>
                    <option value="5" data-region="3">Петропавловка</option>
                  </select>
                </div>
              </div>
            </div>
            <h6 class="mb-2 text-muted">Экологические группы</h6>
            <div class="row mb-3">
              <div class="col-md-3">
                <label class="form-label">Широтная группа</label>
                <select class="form-control" id="create_width_range">
                  <option value="">Выберите группу</option>
                  <option value="Широкая">Широкая</option>
                  <option value="Узкая">Узкая</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Долготная группа</label>
                <select class="form-control" id="create_long_range">
                  <option value="">Выберите группу</option>
                  <option value="Длинная">Длинная</option>
                  <option value="Короткая">Короткая</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Экологическая группа</label>
                <select class="form-control" id="create_ecologic_group">
                  <option value="">Выберите группу</option>
                  <option value="Лесная">Лесная</option>
                  <option value="Степная">Степная</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Трофическая группа</label>
                <select class="form-control" id="create_trophic_group">
                  <option value="">Выберите группу</option>
                  <option value="Хищник">Хищник</option>
                  <option value="Травоядный">Травоядный</option>
                </select>
              </div>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2 mt-3">
              <h6 class="mb-0 text-muted">Изображения</h6>
              <button type="button" class="btn btn-sm btn-outline-secondary toggle-images"
                title="Показать/скрыть управление изображениями">📷</button>
            </div>
            <div class="row mb-3" id="images-section-create" style="display: none;">
              <div class="col-12">
                <input type="file" class="form-control" id="create_image" accept="image/*" style="display: none;">
                <div class="d-flex gap-1 flex-wrap">
                  <button type="button" class="btn btn-outline-primary btn-sm"
                    onclick="$('#create_image').click()">📁</button>
                  <button type="button" class="btn btn-outline-info btn-sm" id="view-image-create">👁️</button>
                  <button type="button" class="btn btn-outline-danger btn-sm" id="delete-image-create">🗑️</button>
                </div>
                <div class="mt-2" id="image-preview-create"></div>
              </div>
            </div>
            <h6 class="mb-2 text-muted mt-3">Описание</h6>
            <div class="row">
              <div class="col-12">
                <textarea class="form-control" id="create_description" rows="2"></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Отмена</button>
          <button type="button" class="btn btn-success btn-sm" id="createBeetleBtn">Создать</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Модальное окно: Создать район/пункт -->
  <div class="modal fade" id="createGeoModal" tabindex="-1" aria-labelledby="createGeoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="createGeoModalLabel">Создать новый элемент</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <!-- Форма охватывает body и footer -->
        <form id="createGeoForm">
          <div class="modal-body">
            <div class="mb-3">
              <label for="geoType" class="form-label">Тип элемента</label>
              <select class="form-select" id="geoType" name="geoType" required>
                <option value="" selected disabled>Выберите тип</option>
                <option value="region">Район</option>
                <option value="point">Пункт</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="geoName" class="form-label">Название</label>
              <input type="text" class="form-control" id="geoName" name="geoName" required>
            </div>
            <div class="mb-3" id="regionSelectGroup" style="display: none;">
              <label for="regionSelect" class="form-label">Район (для пункта)</label>
              <select class="form-select" id="regionSelect" name="regionSelect">
                <option value="" selected disabled>Выберите район</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <!-- Кнопка "Отмена" — просто закрывает модалку -->
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Отмена</button>
            <!-- Кнопка "Сохранить" — отправляет форму -->
            <button type="submit" class="btn btn-primary btn-sm">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // === КОНФИГУРАЦИЯ ===
    const CONFIG = {
      columns: [
        { id: 'family', name: 'Подсемейство', group: 'main', visible: true },
        { id: 'tribe', name: 'Триба', group: 'main', visible: true },
        { id: 'genus', name: 'Род', group: 'main', visible: true },
        { id: 'subgenus', name: 'Подрод', group: 'main', visible: true },
        { id: 'species', name: 'Вид', group: 'main', visible: true },
        { id: 'region', name: 'Районы', group: 'geo', visible: true },
        { id: 'points', name: 'Пункты', group: 'geo', visible: true },
        { id: 'width_range', name: 'Широтная группа', group: 'eco', visible: true },
        { id: 'long_range', name: 'Долготная группа', group: 'eco', visible: true },
        { id: 'ecologic_group', name: 'Экологическая группа', group: 'eco', visible: true },
        { id: 'trophic_group', name: 'Трофическая группа', group: 'eco', visible: true },
        { id: 'tiered_group', name: 'Ярусная группа', group: 'eco', visible: true },
        { id: 'description', name: 'Описание', group: 'extra', visible: false }
      ],
      groups: {
        main: 'Основные',
        eco: 'Экологические',
        geo: 'Географические',
        extra: 'Дополнительное'
      },
      modalFields: [
        'family', 'tribe', 'genus', 'subgenus', 'species',
        'regions', 'points', 'width_range', 'long_range',
        'ecologic_group', 'trophic_group', 'description'
      ]
    };

    // === ОСНОВНОЙ КЛАСС ===
    class BeetleTable {
      constructor() {
        this.beetles = [];
        this.columns = [...CONFIG.columns];
        this.grid = null;
        this.loadBeetles();
        this.init();
      }

      loadBeetles() {
        this.beetles = [];
        $('#data_table tbody tr').each((_, row) => {
          const rowData = Array.from(row.cells).map(cell => cell.innerText.trim());
          this.beetles.push(rowData);
        });
      }

      init() {
        this.initSelect2();
        this.renderColumnControls();
        this.renderTable();
        this.bindEvents();
      }

      initSelect2() {
        $('.multiple-select').select2({ placeholder: 'Выберите опции' })
          .off('select2:unselect')
          .off('select2:select')
          .on('select2:unselect', (e) => this.handleUnselect(e))
          .on('select2:select', (e) => this.handleSelect(e));
      }

      handleUnselect(e) {
        const $el = $(e.target);
        const isRegions = $el.attr('id').endsWith('regions');
        const modal = $el.attr('id').split('_')[0];
        const $points = $(`#${modal}_points`);
        const pointsValues = ($points.val() || []).slice();
        const data = e.params.data;
        const region = isRegions ? data.id : $(data.element).data('region');

        let shouldRemoveRegion = false;

        $points.find(`option[data-region="${region}"]`).each((_, opt) => {
          if (pointsValues.includes(opt.value)) {
            if (!isRegions) {
              shouldRemoveRegion = true;
            }
          }
        });

        if (isRegions) {
          const newPoints = pointsValues.filter(val => {
            const optRegion = $(`#${modal}_points option[value="${val}"]`).data('region');
            return optRegion !== region;
          });
          if (newPoints.length !== pointsValues.length) {
            $points.val(newPoints).trigger('change');
          }
        }

        if (!isRegions && shouldRemoveRegion) {
          const $regions = $(`#${modal}_regions`);
          const regions = ($regions.val() || []).filter(r => r !== region);
          $regions.val(regions).trigger('change');
        }
      }

      handleSelect(e) {
        const $el = $(e.target);
        if (!$el.attr('id').endsWith('points')) return;

        const modal = $el.attr('id').split('_')[0];
        const $regions = $(`#${modal}_regions`);
        const region = $(e.params.data.element).data('region');
        const selectedRegions = new Set($regions.val() || []);

        if (region && !selectedRegions.has(region)) {
          selectedRegions.add(region);
          $regions.val([...selectedRegions]).trigger('change');
        }
      }

      renderColumnControls() {
        Object.keys(CONFIG.groups).forEach(group => {
          const container = $(`#${group} .tab-pane-content`);
          const cols = this.columns.filter(c => c.group === group && c.name !== 'Вид');
          const toggleId = `toggleAll${group.charAt(0).toUpperCase() + group.slice(1)}`;

          container.find('.column-toggle').closest('.form-check').remove();

          cols.forEach(col => {
            const label = col.name.replace(' группа', '');
            container.append(`
            <div class="form-check form-switch">
              <input class="form-check-input column-toggle" type="checkbox" value="${col.id}" ${col.visible ? 'checked' : ''} id="check_${col.id}">
              <label class="form-check-label" for="check_${col.id}">${label}</label>
            </div>
          `);
          });

          const $toggle = $(`#${toggleId}`);
          $toggle.off('change').on('change', () => {
            const checked = $toggle.prop('checked');
            container.find('.column-toggle').prop('checked', checked);
            this.syncGlobalToggle();
            this.renderTable();
          });
        });

        $('#toggleAllGlobal').off('change').on('change', () => {
          const checked = $('#toggleAllGlobal').prop('checked');
          $('.column-toggle').prop('checked', checked);
          $('.toggle-all-local').prop('checked', checked);
          this.renderTable();
        });

        this.syncGlobalToggle();
      }

      syncGlobalToggle() {
        const allChecked = Object.keys(CONFIG.groups).every(group =>
          $(`#toggleAll${group.charAt(0).toUpperCase() + group.slice(1)}`).prop('checked')
        );
        $('#toggleAllGlobal').prop('checked', allChecked);
      }

      getVisibleColumns() {
        return this.columns.filter(c => c.visible);
      }

      renderTable() {
        this.columns.forEach(col => {
          if (col.id === 'actions') return;
          const checkbox = $(`.column-toggle[value="${col.id}"]`);
          if (checkbox.length) col.visible = checkbox.is(':checked');
        });

        const visibleCols = this.getVisibleColumns();
        const searchInput = document.querySelector('.gridjs-search input');
        const keyword = searchInput ? searchInput.value : '';

        // Формируем колонки с data-column-id
        const columns = visibleCols.map(col => ({
          name: col.name,
          sort: true,
          hidden: !col.visible,
          attributes: {
            'data-column-id': col.id
          },
          formatter: col.formatter
        }));

        // Добавляем столбец "Действия" с data-column-id
        columns.push({
          name: 'Действия',
          sort: false,
          attributes: {
            'data-column-id': 'actions'
          },
          formatter: (_, row) => {
            const data = row.cells.map(c => c.data);
            const idx = this.beetles.findIndex(beetle =>
              beetle[0] === data[0] && beetle[1] === data[1] &&
              beetle[2] === data[2] && beetle[3] === data[3] && beetle[4] === data[4]
            );
            return gridjs.html(`<button class="btn btn-secondary btn-sm view-details-btn" data-bs-toggle="modal" data-bs-target="#detailsModal" data-row-index="${idx}">Подробнее</button>`);
          }
        });

        if (this.grid) {
          this.grid.updateConfig({ columns, search: { keyword } }).forceRender();
        } else {
          this.grid = new gridjs.Grid({
            columns,
            data: this.beetles,
            resizable: true,
            sort: true,
            search: true,
            pagination: { enabled: true, limit: 25 },
            language: {
              search: { placeholder: 'Поиск по таблице...' },
              pagination: { previous: 'Назад', next: 'Вперед', showing: 'Показано с', to: 'по', of: 'из', results: 'результатов' },
              loading: 'Загрузка...',
              noRecordsFound: 'Записей не найдено'
            },
            className: {
              table: 'table table-bordered table-striped table-hover table-sm',
              thead: 'table-dark'
            },
            style: {
              td: { padding: '6px' },
              table: { fontSize: '14px' }
            }
          }).render(document.getElementById('table-wrapper'));
        }

        this.bindHighlight();
      }

      bindHighlight() {
        $(document).off('mouseenter', '.form-switch, .toggle-all-local, #toggleAllGlobal')
          .off('mouseleave', '.form-switch, .toggle-all-local, #toggleAllGlobal');

        // Подсветка для обычных чекбоксов столбцов
        $(document).on('mouseenter', '.form-switch', (e) => {
          const $cb = $(e.currentTarget).find('.column-toggle');
          if (!$cb.length || !$cb.is(':checked')) return;
          const colId = $cb.val();
          if (colId === 'species') return; // 🔴 Игнорируем "Вид"
          const visibleIndex = this.getVisibleColumns().findIndex(c => c.id === colId);
          if (visibleIndex === -1) return;
          $('#table-wrapper table tr').each((_, row) => {
            $(row).find(`th:eq(${visibleIndex}), td:eq(${visibleIndex})`)
              .addClass('highlight-column');
          });
        });

        // Подсветка для локальных тумблеров групп
        $(document).on('mouseenter', '.toggle-all-local', (e) => {
          const $toggle = $(e.currentTarget);
          const groupId = $toggle.attr('id').replace('toggleAll', '').toLowerCase();
          const colsInGroup = this.columns
            .filter(c => c.group === groupId && c.visible && c.id !== 'species') // 🔴 Исключаем "Вид"
            .forEach(c => {
              const idx = this.getVisibleColumns().findIndex(col => col.id === c.id);
              if (idx === -1) return;
              $('#table-wrapper table tr').each((_, row) => {
                $(row).find(`th:eq(${idx}), td:eq(${idx})`).addClass('highlight-column');
              });
            });
        });

        // Подсветка для глобального тумблера
        $(document).on('mouseenter', '#toggleAllGlobal', () => {
          this.getVisibleColumns()
            .filter(c => c.id !== 'species') // 🔴 Исключаем "Вид"
            .forEach(c => {
              const idx = this.getVisibleColumns().findIndex(col => col.id === c.id);
              if (idx === -1) return;
              $('#table-wrapper table tr').each((_, row) => {
                $(row).find(`th:eq(${idx}), td:eq(${idx})`).addClass('highlight-column');
              });
            });
        });

        // Сброс подсветки
        $(document).on('mouseleave', '.form-switch, .toggle-all-local, #toggleAllGlobal', () => {
          $('#table-wrapper table th, #table-wrapper table td').removeClass('highlight-column');
        });
      }

      bindEvents() {
        $(document).on('change', '.column-toggle', () => this.renderTable());
      }
    }

    // === УТИЛИТЫ ===
    function fillModal(modalPrefix, data = []) {
      CONFIG.modalFields.forEach((field, i) => {
        const selector = `#${modalPrefix}_${field}`;
        const value = data[i] || '';
        if (['regions', 'points'].includes(field)) {
          const $select = $(selector);
          const opts = value ? value.split(", ").map(v => {
            if (field === 'regions' && v !== 'Улан-Удэ') v += ' район';
            if ($select.find(`option[value="${v}"]`).length === 0) {
              $select.append(new Option(v, v));
            }
            return v;
          }) : [];
          $select.val(opts).trigger('change');
        } else {
          $(selector).val(value);
        }
      });
    }

    // === ОБРАБОТЧИКИ СОБЫТИЙ ===
    $(document).ready(() => {
      const beetleTable = new BeetleTable();

      // Модалка деталей
      $('#detailsModal').on('show.bs.modal', function (e) {
        const idx = e.relatedTarget.getAttribute('data-row-index');
        const beetle = beetleTable.beetles[idx];
        $('#edit_id').val(idx);
        fillModal('edit', beetle);
        $('#edit_species').val(beetle[4]);
        $('#edit_description').val(beetle[12] || '');
      });

      // Тогглы секций
      $('.toggle-geography, .toggle-images').on('click', function () {
        const $this = $(this);
        const modal = $this.closest('.modal');
        const section = modal.find(`#${$this.closest('.d-flex').next().attr('id')}`);
        section.slideToggle(200, () => {
          $this.text(section.is(':visible') ? 'скрыть' : 'показать');
          $this.attr('title', section.is(':visible') ? 'Скрыть' : 'Показать');
        });
      });

      // Загрузка изображений
      $('#edit_image, #create_image').on('change', function () {
        const file = this.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
          const modal = $(this).closest('.modal');
          const preview = modal.find('[id^="image-preview"]');
          preview.html(`<img src="${e.target.result}" class="img-thumbnail" style="max-width: 200px; max-height: 150px;">`);
        };
        reader.readAsDataURL(file);
      });

      // Удаление изображения
      $(document).on('click', '[id^="delete-image"]', function () {
        const modal = $(this).closest('.modal');
        const preview = modal.find('[id^="image-preview"]');
        const input = modal.find('input[type="file"]');
        preview.html(`<img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmOWZhIi8+CiAgPHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzZjNzU3ZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zNWVtIj7QndC10YIg0LjQt9C+0LHRgNCw0LbQtdC90LjRjzwvdGV4dD4KICA8L3N2Zz4K" class="img-thumbnail" style="max-width: 200px; max-height: 150px;">`);
        input.val('');
      });

      // Управление гео-объектами
      $('#geoType').on('change', function () {
        const type = $(this).val();
        if (type === 'point') {
          $('#regionSelectGroup').show();
          const $select = $('#regionSelect').empty().append('<option value="" selected disabled>Выберите район</option>');
          $('#edit_regions option, #create_regions option').each(function () {
            const val = $(this).val();
            const text = $(this).text();
            if (val && !$select.find(`option[value="${val}"]`).length) {
              $select.append(new Option(text, val));
            }
          });
        } else {
          $('#regionSelectGroup').hide();
        }
      });

      $('#saveGeoBtn').on('click', function () {
        const type = $('#geoType').val();
        const name = $('#geoName').val().trim();
        const region = $('#regionSelect').val();
        if (!type || !name) return alert('Заполните все поля.');
        if (type === 'point' && !region) return alert('Выберите район для пункта.');

        const option = new Option(name, name);
        if (type === 'point') $(option).data('region', region);

        const $editPoints = $('#edit_points');
        const $createPoints = $('#create_points');
        const $editRegions = $('#edit_regions');
        const $createRegions = $('#create_regions');

        if (type === 'point') {
          if (!$editPoints.find(`option[value="${name}"]`).length) {
            $editPoints[0].add(option.cloneNode(true));
          }
          if (!$createPoints.find(`option[value="${name}"]`).length) {
            $createPoints[0].add(option.cloneNode(true));
          }
        }

        if (!$editRegions.find(`option[value="${name}"]`).length) {
          $editRegions[0].add(option);
        }
        if (!$createRegions.find(`option[value="${name}"]`).length) {
          $createRegions[0].add(option);
        }

        alert(`✅ ${type === 'region' ? 'Район' : 'Пункт'} "${name}" создан!`);
        $('#createGeoForm')[0].reset();
        $('#regionSelectGroup').hide();
        $('#createGeoModal').modal('hide');
      });

      $('#createGeoModal').on('hidden.bs.modal', function () {
        $('#createGeoForm')[0].reset();
        $('#regionSelectGroup').hide();
      });

      $('#createBeetleBtn').on('click', () => {
        alert('Новая жужелица создана (имитация)');
      });
    });
  </script>
</body>

</html>